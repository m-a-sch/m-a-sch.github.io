<!DOCTYPE HTML>
<html>
  
<head>
    <title>
        Breathe!!!
    </title>
    <style>
       
          
        canvas {
            background-color: skyblue;
            width: 100%;
            height: 90%;
            position: absolute;
            top: 10%;
        }
    </style>
</head>
  
<body>
        <canvas></canvas>
        <center> set your breathing pace: 1'' <input type="range" id="speed" min="1" max="7" value="7"> 7''</center>
        <script>
            var canvas = document.querySelector("canvas");
            canvas.width = innerWidth;
            canvas.height = innerHeight;
            var startTime = Date.now();
            var endTime = Date.now();
            var l = canvas.getContext('2d');
          
            // x and y are the coordinates of the circle
            // vx and vy are the respective speeds
            var x = Math.floor(0.5 * innerWidth);
            var y = innerHeight;
            var vx = 0;
            var vy = 0;
            var radius = 100;
            
            // how many updates knowing we want speed / timeBetweenFrames
            var timeBetweenFrames = 5;
            var wantedTime=parseInt(document.getElementById("speed").value)*1000;
            // we have the following variables to play with in order to ensure the correct timing.
            var distance = innerHeight - radius;
            var stepSize = 7;
            var steps = Math.floor(distance/stepSize);
            var processTimePerStep = 2;
            var waitTimePerStep = 29;
            var okColor="black";
            var message="tuning";
            // achievedTime = steps * (waitTimePerStep + processTimePerStep) or
            // steps = wantedTime / (waitTimePerStep + processTimePerStep)
            // I have a distance in pixels, like 600 and a number of milliseconds to go through it -> pixels/millisecond
            // let's assume that the computer is fast enough to always do a distance number of moves distance - time = the total time to wait and the total time to wait/distance is the time to wait between each move
            
            var achievedTime = wantedTime;
            var correction = wantedTime / achievedTime;
            vy=stepSize;
            function wait(milliseconds) {
                    var start = new Date().getTime();
                    for (var i = 0; i < 1e7; i++) {
                        if ((new Date().getTime() - start) > milliseconds){
                            break;
                            }
                        }
                    }
            function adjust()
                    {
                    diffTime=Date.now()-startTime;
                    startTime=Date.now();
                    wantedTime=parseInt(document.getElementById("speed").value)*1000;
                    achievedTime = diffTime;
                    if (Math.abs((wantedTime-achievedTime) / wantedTime) > 0.12)
                        {
                        okColor="red";
                        message="tuning";
                        waitTimePerStep = waitTimePerStep + Math.floor((wantedTime - achievedTime)/steps);
                        }
                    else
                        {
                        okColor="white";
                        message="ok";
                        }
                    //console.log( (wantedTime - achievedTime), distance, steps, waitTimePerStep );
          
                    }
            move();
          
            // This function will do the animation
            function move() {
                wait(waitTimePerStep);
                l.clearRect(0, 0, innerWidth, innerHeight);
                l.beginPath();
                l.strokeStyle = "black";
                l.lineWidth = 5;
                r=Math.floor(radius * (innerHeight - y) / innerHeight)+1;
                l.arc(x, y, r, 0, Math.PI * 2, false);
                l.fillStyle = okColor;
                l.textAlign="center";
                if (message == "ok")
                    {
                    
                }
                l.fillText(message, x, y);
                l.stroke();
                if (y + 1 > innerHeight)
                    {
                    if ( distance == (innerHeight - radius))
                        {
                        okColor = "black";
                        message= "tuning";
                        adjust();
                        }
                    else
                        {
                        okColor="black";
                        message= "tuning";
                        distance = innerHeight - radius;
                        steps = Math.floor(distance/stepSize);
                        }
                    vy = 0 - stepSize;
                    }

          
                if (y - radius < 0)
                    {
                    if ( distance == (innerHeight - radius))
                        {
                        okColor="black";
                        message= "tuning";
                        adjust();
                        }
                    else
                        {
                        okColor="black";
                        message= "tuning";
                        distance = innerHeight - radius;
                        steps = Math.floor(distance/stepSize);
                        }
                    vy=stepSize;
                    }
                y = y + vy;
                requestAnimationFrame(move);
            }
        </script>

</body>
  
</html>
