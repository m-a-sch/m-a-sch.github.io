<!DOCTYPE HTML>
<html>
  
<head>
    <title>
        Breathe!!!
    </title>
    <style>
       
       input#speed {
         height: 10% !important;
         font-size: 100%;
         width: 100%;
         top: 0px;
       }
        canvas {
            background-color: skyblue;
            width: 100%;
            height: 90%;
            position: absolute;
            top: 10%;
            left: 0px;
        }
    </style>
</head>
  
<body>
        <canvas></canvas>
        <input type="number" id="speed" min="5" max="15" value="10">Cycles/minute</input>
        <script>
            var canvas = document.querySelector("canvas");
            canvas.width = innerWidth;
            canvas.height = innerHeight;
            var startTime = Date.now();
            var endTime = Date.now();
            var breathingArea = canvas.getContext('2d');
          
            // x and y are the coordinates of the circle
            // vx and vy are the respective speeds
            var x = Math.floor(0.5 * innerWidth);
            var y = innerHeight;
            var vx = 0;
            var vy = 0;
            var radius = 100;
            var count=0;
            
           
            var wantedTime=(60/parseInt(document.getElementById("speed").value))/2*1000;
            // we have the following variables to play with in order to ensure the correct timing.
            var distance = innerHeight - radius;
            var stepSize = 7;
            var steps = Math.floor(distance/stepSize);
            
            var waitTimePerStep = 29;
            var okColor="black";
            var message="tuning";
              
            var achievedTime = wantedTime;
            var correction = wantedTime / achievedTime;
            vy=stepSize;
            function adjust()
                    {
                    diffTime=Date.now()-startTime;
                    startTime=Date.now();
                    wantedTime=(60/parseInt(document.getElementById("speed").value))/2*1000;
                    achievedTime = diffTime;
                    if (Math.abs((wantedTime-achievedTime) / wantedTime) > 0.1)
                        {
                        count=0;
                        okColor="red";
                        message="calibrating device";
                        waitTimePerStep = waitTimePerStep + Math.floor((wantedTime - achievedTime)/steps);
                        }
                    else
                        {
                        okColor="white";
                        message="ok";
                        
                        }
                    //console.log( (wantedTime - achievedTime), distance, steps, waitTimePerStep );
          
                    }
            move();
          
            
            function moveafter()
                {
                setTimeout(move,waitTimePerStep)
                }
                
            function move() {
                
                breathingArea.clearRect(0, 0, innerWidth, innerHeight);
                breathingArea.beginPath();
                breathingArea.strokeStyle = okColor;
                breathingArea.lineWidth = 5;
                r=Math.floor(radius * (innerHeight - y) / innerHeight)+1;
                breathingArea.arc(x, y, r, 0, Math.PI * 2, false);
                breathingArea.fillStyle = okColor;
                breathingArea.textAlign="left";
                if (okColor == "white")
                    {
                    breathingArea.fillText(count, 10, innerHeight - 20);
                    }
                else
                    {
                    breathingArea.fillText(message, 10, innerHeight - 20);
                    }
                breathingArea.stroke();
                if (y + 1 > innerHeight)
                    {
                    if ( distance == (innerHeight - radius))
                        {
                        okColor = "black";
                        message= "tuning";
                        adjust();
                        }
                    else
                        {
                        okColor="black";
                        message= "tuning";
                        distance = innerHeight - radius;
                        steps = Math.floor(distance/stepSize);
                        }
                    vy = 0 - stepSize;
                    }

          
                if (y - radius < 0)
                    {
                    count += 1;
                    if ( distance == (innerHeight - radius))
                        {
                        okColor="black";
                        message= "tuning";
                        adjust();
                        }
                    else
                        {
                        okColor="black";
                        message= "tuning";
                        distance = innerHeight - radius;
                        steps = Math.floor(distance/stepSize);
                        }
                    vy=stepSize;
                    }
                y = y + vy;
                requestAnimationFrame(moveafter);
            }
        </script>

</body>
  
</html>
