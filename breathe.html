<!DOCTYPE HTML>
<html>
  
<head>
    <title>
        Breathe!!!
    </title>
    <style>
       
       input#speed {
         height: 30px !important;
         font-size: 20px;
         width: 20%;
         text-align: center;
         
       }
    button#slower {
      height: 50px !important;
      font-size: 20px;
      width: 30%;
      background-color: palevioletred;
      
    }
    button#faster {
      height: 50px !important;
      font-size: 20px;
      width: 30%;
      background-color: palegreen;
      
    }
        canvas {
            background-color: skyblue;
            width: 100%;
            height: 90%;
            position: absolute;
            top: 10%;
            left: 0px;
        }
    </style>
</head>
  
<body>
        <canvas></canvas><center>
        <button id="slower" onClick=slower()>-</button><input type="text" disabled id="speed" value="10"><button id="faster" onClick=faster()>+</button></center>
        <script>
            
var canvas = document.querySelector("canvas");
canvas.width = innerWidth;
canvas.height = innerHeight;
var startTime = Date.now();
var endTime = Date.now();
var breathingArea = canvas.getContext('2d');
          

var x = Math.floor(0.5 * innerWidth);
var y = innerHeight;
var vx = 0;
var vy = 0;
var radius = 100;
var r = radius;
var count=0;
var calibrationSteps = 0;
var inout = "in";
           
var wantedTime=(60/parseInt(document.getElementById("speed").value))*1000;
var distance = innerHeight - radius;
            
            
const stepSizeDefault = 8;
var stepSize = stepSizeDefault;
var steps = distance/stepSize;
            
            
var waitTimePerStep = 10;
var waitTests = Array([0,waitTimePerStep,waitTimePerStep*4],[0,0,0]);
var okColor="black";
var message="tuning";
              
var achievedTime = wantedTime;
            
vy=stepSize;
function slower()
    {
    current = parseInt(document.getElementById("speed").value);
    current -= 1;
    document.getElementById("speed").value=Math.max(3,current);
    }
function faster()
    {
    current = parseInt(document.getElementById("speed").value);
    current += 1;
    document.getElementById("speed").value=Math.min(15,current);
    }
function didAnythingChange ()
    {
    if (message != "ok")
        return true
    if (Math.abs(distance - (innerHeight - radius)) >= 0.01 )
        {// something changed in the device size
        stepSize = stepSizeDefault;
        distance = innerHeight - radius;
        steps = distance/stepSize;
        return true;
        }
    if (Math.abs(wantedTime - ((60/parseInt(document.getElementById("speed").value))*1000)) >= 0.01 )
        {//user changed the pace
        stepSize = stepSizeDefault;
        steps = distance/stepSize;
        return true
        }
    return false
    }
function adjust()
    {
    if (didAnythingChange() == false)
        return
    diffTime=Date.now()-startTime;
    startTime=Date.now();
    wantedTime=(60/parseInt(document.getElementById("speed").value))*1000;
    achievedTime = diffTime;
    if (Math.abs((wantedTime-achievedTime) / wantedTime) > 0.1)
        {
        waitTests[1][calibrationSteps]=wantedTime-achievedTime;
        waitTimePerStep=waitTests[0][calibrationSteps+1]
        calibrationSteps += 1;
        count=0;
        okColor="red";
        message="calibrating device";
        if (calibrationSteps  == 3)
            {
            a=(waitTests[1][2]-waitTests[1][1]) / (waitTests[0][2]-waitTests[0][1]);
            b=waitTests[1][1]-(waitTests[0][1]*a);
            waitTimePerStep=Math.round((0-b)/a);
            calibrationSteps = 0;
            okColor="white";
            message="ok";
            }
                                      
        }
    else
        {
        calibrationSteps = 0;
        okColor="white";
        message="ok";
        }
                  
    }

move();
          
            
function moveafter()
    {
    diffInOut=0
    if (message=="ok")
        diffInOut=0.21
    if (inout == "in")
        setTimeout(move,Math.round(waitTimePerStep-(waitTimePerStep*diffInOut)))
    else
        setTimeout(move,Math.round(waitTimePerStep+(waitTimePerStep*diffInOut)))
    }
                
function move()
    {
    breathingArea.clearRect(0, 0, innerWidth, innerHeight);
    breathingArea.beginPath();
    breathingArea.strokeStyle = okColor;
    breathingArea.lineWidth = 5;
    r=Math.max(Math.floor(radius * (innerHeight - y) / innerHeight),1);
    breathingArea.arc(x, y, r, 0, Math.PI * 2, false);
    breathingArea.fillStyle = okColor;
    breathingArea.textAlign="left";
    if (okColor == "white")
        {
        breathingArea.fillText(inout+ " ("+  count+")", 10, innerHeight - 20);
        }
    else
        {
        breathingArea.fillText(message + " ("+calibrationSteps+")", 10, innerHeight - 20);
        }
    breathingArea.stroke();
    if (y + 1 > innerHeight)
        {
        adjust();
        inout="in";
        vy = 0 - stepSize;
        }

          
    if (y - radius < 0)
        {
        count += 1;
        inout="out";
        vy=stepSize;
        }
    y = y + vy;
    requestAnimationFrame(moveafter);
    }
        </script>

</body>
  
</html>
